# Sprint 4 FIAP - RM558253
# Pipeline CI/CD para Azure DevOps
# Deploy em Azure Container Instance (ACI)

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Configura√ß√µes do Azure - AJUSTE AQUI
  azureSubscription: 'azure-service-connection'  # Nome da sua service connection ARM
  resourceGroup: 'rg-sprint4-rm558253'
  location: 'eastus'
  acrName: 'acrsprint4rm558253'
  aciName: 'aci-sprint4-rm558253'
  imageName: 'sprint4-app'
  tag: '$(Build.BuildId)'
  
  # Configura√ß√µes do banco de dados
  mysqlServerName: 'mysql-sprint4-rm558253'
  mysqlDatabase: 'sprint4'

stages:
  # STAGE 1: BUILD - Compila√ß√£o e Testes
  - stage: Build
    displayName: 'Build e Testes'
    jobs:
      - job: BuildJob
        displayName: 'Build Java Application'
        steps:
          - task: Maven@3
            displayName: 'Maven Build e Testes'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests=false'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
              mavenAuthenticateFeed: false
              effectivePomSkip: false
              sonarQubeRunAnalysis: false

          - task: CopyFiles@2
            displayName: 'Copiar Artefatos'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/target'
              Contents: '*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefatos'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  # STAGE 2: IMAGE - Build e Push da Imagem Docker
  - stage: Image
    displayName: 'Build e Push Docker Image'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DockerJob
        displayName: 'Build Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Build e Push Docker Image'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üê≥ Login no Azure Container Registry..."
                az acr login --name $(acrName)
                
                echo "üèóÔ∏è  Build da imagem Docker..."
                docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .
                docker tag $(acrName).azurecr.io/$(imageName):$(tag) $(acrName).azurecr.io/$(imageName):latest
                
                echo "üì§ Push da imagem para ACR..."
                docker push $(acrName).azurecr.io/$(imageName):$(tag)
                docker push $(acrName).azurecr.io/$(imageName):latest
                
                echo "‚úÖ Imagem publicada com sucesso!"
                echo "   - $(acrName).azurecr.io/$(imageName):$(tag)"
                echo "   - $(acrName).azurecr.io/$(imageName):latest"

  # STAGE 3: DEPLOY - Deploy para Azure Container Instance
  - stage: Deploy
    displayName: 'Deploy to Azure ACI'
    dependsOn: Image
    condition: succeeded()
    jobs:
      - deployment: DeployACI
        displayName: 'Deploy to Container Instance'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to ACI'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üöÄ Iniciando deploy no Azure Container Instance..."
                      
                      # Obter credenciais do banco
                      DB_HOST=$(az mysql flexible-server show \
                        --resource-group $(resourceGroup) \
                        --name $(mysqlServerName) \
                        --query "fullyQualifiedDomainName" -o tsv 2>/dev/null || echo "localhost")
                      
                      # Senha padr√£o (use Key Vault em produ√ß√£o)
                      DB_PASSWORD="Sprint4@RM558253Fiap"
                      
                      # Obter credenciais do ACR
                      ACR_USERNAME=$(az acr credential show \
                        --name $(acrName) \
                        --query "username" -o tsv)
                      
                      ACR_PASSWORD=$(az acr credential show \
                        --name $(acrName) \
                        --query "passwords[0].value" -o tsv)
                      
                      # Deletar container existente se houver
                      az container delete \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --yes 2>/dev/null || true
                      
                      # Deploy no ACI
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --image $(acrName).azurecr.io/$(imageName):$(tag) \
                        --registry-login-server $(acrName).azurecr.io \
                        --registry-username $ACR_USERNAME \
                        --registry-password $ACR_PASSWORD \
                        --dns-name-label sprint4-rm558253 \
                        --ports 8080 \
                        --cpu 1 \
                        --memory 2 \
                        --environment-variables \
                          DB_HOST=$DB_HOST \
                          DB_PORT=3306 \
                          DB_NAME=$(mysqlDatabase) \
                          DB_USER=adminuser \
                          DB_PASSWORD=$DB_PASSWORD \
                        --restart-policy Always \
                        --location $(location)
                      
                      echo "‚úÖ Deploy conclu√≠do!"
                      echo "üåê URL: http://sprint4-rm558253.$(location).azurecontainer.io:8080"

                - task: AzureCLI@2
                  displayName: 'Verificar Status do Deploy'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üîç Verificando status do container..."
                      az container show \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --query "{Status:instanceView.state, FQDN:ipAddress.fqdn, IP:ipAddress.ip}" \
                        -o table
                      
                      echo "üìã Logs do container:"
                      az container logs \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --tail 50
