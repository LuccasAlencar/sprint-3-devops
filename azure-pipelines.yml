# Pipeline CI/CD para Azure DevOps
# Deploy em Azure Container Instance (ACI) com Azure Database for MySQL

trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Importar Variable Group
- group: sprint4-secrets

  # Configura√ß√µes do Azure
- name: azureSubscription
  value: 'azure-service-connection'
- name: resourceGroup
  value: 'rg-sprint4-rm558253'
- name: location
  value: 'eastus'
- name: acrName
  value: 'acrsprint4rm558253'
- name: aciName
  value: 'aci-sprint4-rm558253'
- name: imageName
  value: 'sprint4-app'
- name: tag
  value: '$(Build.BuildId)'

  # Configura√ß√µes do banco de dados Azure Database for MySQL
- name: mysqlServerName
  value: 'mysql-sprint4-rm558253'
- name: mysqlDatabase
  value: 'sprint4'
- name: mysqlAdminUser
  value: 'adminuser'

stages:
  # STAGE 1: BUILD - Compila√ß√£o e Testes
  - stage: Build
    displayName: 'Build e Testes'
    jobs:
      - job: BuildJob
        displayName: 'Build Java Application'
        steps:
          - task: Maven@3
            displayName: 'Maven Build e Testes'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests=false'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'
              mavenAuthenticateFeed: false
              effectivePomSkip: false
              sonarQubeRunAnalysis: false

          - task: CopyFiles@2
            displayName: 'Copiar Artefatos'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/target'
              Contents: '*.jar'
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publicar Artefatos'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  # STAGE 2: IMAGE - Build e Push da Imagem Docker
  - stage: Image
    displayName: 'Build e Push Docker Image'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DockerJob
        displayName: 'Build Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Build e Push Docker Image'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üê≥ Login no Azure Container Registry..."
                az acr login --name $(acrName)

                echo "üèóÔ∏è  Build da imagem Docker..."
                docker build -t $(acrName).azurecr.io/$(imageName):$(tag) .
                docker tag $(acrName).azurecr.io/$(imageName):$(tag) $(acrName).azurecr.io/$(imageName):latest
                
                echo "üì§ Push da imagem para ACR..."
                docker push $(acrName).azurecr.io/$(imageName):$(tag)
                docker push $(acrName).azurecr.io/$(imageName):latest

                echo "‚úÖ Imagem publicada com sucesso!"
                echo "   - $(acrName).azurecr.io/$(imageName):$(tag)"
                echo "   - $(acrName).azurecr.io/$(imageName):latest"

  # STAGE 3: DEPLOY - Deploy para Azure Container Instance
  - stage: Deploy
    displayName: 'Deploy to Azure ACI'
    dependsOn: Image
    condition: succeeded()
    jobs:
      - deployment: DeployACI
        displayName: 'Deploy to Container Instance'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Verificar/Criar Azure Database for MySQL'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üóÑÔ∏è  Verificando Azure Database for MySQL..."
                      
                      # Verificar se o servidor MySQL j√° existe
                      if az mysql flexible-server show \
                          --resource-group $(resourceGroup) \
                          --name $(mysqlServerName) &>/dev/null; then
                        echo "‚úÖ Azure Database for MySQL j√° existe"
                      else
                        echo "üì¶ Criando Azure Database for MySQL..."
                        
                        # Criar MySQL Flexible Server
                        az mysql flexible-server create \
                          --resource-group $(resourceGroup) \
                          --name $(mysqlServerName) \
                          --location $(location) \
                          --admin-user $(mysqlAdminUser) \
                          --admin-password "$(MYSQL_ADMIN_PASSWORD)" \
                          --sku-name Standard_B1ms \
                          --tier Burstable \
                          --storage-size 32 \
                          --version 8.0.21 \
                          --public-access 0.0.0.0-255.255.255.255 \
                          --yes
                        
                        echo "‚úÖ Azure Database for MySQL criado"
                        
                        # Aguardar o servidor ficar pronto
                        echo "‚è≥ Aguardando servidor MySQL ficar pronto..."
                        sleep 60
                        
                        # Criar database
                        echo "üì¶ Criando database..."
                        az mysql flexible-server db create \
                          --resource-group $(resourceGroup) \
                          --server-name $(mysqlServerName) \
                          --database-name $(mysqlDatabase)
                        
                        echo "‚úÖ Database criado"
                      fi
                      
                      # Obter FQDN do MySQL
                      MYSQL_HOST=$(az mysql flexible-server show \
                        --resource-group $(resourceGroup) \
                        --name $(mysqlServerName) \
                        --query "fullyQualifiedDomainName" -o tsv)
                      
                      echo "MySQL Host: $MYSQL_HOST"
                      echo "##vso[task.setvariable variable=MYSQL_HOST]$MYSQL_HOST"

                - task: AzureCLI@2
                  displayName: 'Executar Script SQL no MySQL'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üíæ Executando script SQL..."
                      
                      # Download do script SQL do reposit√≥rio
                      curl -o script_bd.sql https://raw.githubusercontent.com/LuccasAlencar/sprint-3-devops/main/script_bd.sql || {
                        echo "‚ö†Ô∏è  Usando script SQL local"
                        cp script_bd.sql /tmp/script_bd.sql
                      }
                      
                      # Instalar MySQL client
                      sudo apt-get update && sudo apt-get install -y mysql-client
                      
                      # Executar script SQL
                      mysql -h $(MYSQL_HOST) \
                            -u $(mysqlAdminUser) \
                            -p"$(MYSQL_ADMIN_PASSWORD)" \
                            --ssl-mode=REQUIRED \
                            < script_bd.sql && echo "‚úÖ Script SQL executado com sucesso" || {
                        echo "‚ö†Ô∏è  Tentando novamente em 30 segundos..."
                        sleep 30
                        mysql -h $(MYSQL_HOST) \
                              -u $(mysqlAdminUser) \
                              -p"$(MYSQL_ADMIN_PASSWORD)" \
                              --ssl-mode=REQUIRED \
                              < script_bd.sql && echo "‚úÖ Script SQL executado" || {
                          echo "‚ö†Ô∏è  Execute manualmente depois se necess√°rio"
                        }
                      }

                - task: AzureCLI@2
                  displayName: 'Deploy to ACI'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üöÄ Iniciando deploy no Azure Container Instance..."
                      
                      # Obter credenciais do ACR
                      ACR_USERNAME=$(az acr credential show \
                        --name $(acrName) \
                        --query "username" -o tsv)

                      ACR_PASSWORD=$(az acr credential show \
                        --name $(acrName) \
                        --query "passwords[0].value" -o tsv)

                      # Deletar container existente se houver
                      az container delete \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --yes 2>/dev/null || true

                      # Deploy no ACI
                      az container create \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --image $(acrName).azurecr.io/$(imageName):$(tag) \
                        --os-type Linux \
                        --registry-login-server $(acrName).azurecr.io \
                        --registry-username $ACR_USERNAME \
                        --registry-password $ACR_PASSWORD \
                        --dns-name-label sprint4-rm558253 \
                        --ports 8080 \
                        --cpu 1 \
                        --memory 2 \
                        --environment-variables \
                          DB_HOST=$(MYSQL_HOST) \
                          DB_PORT=3306 \
                          DB_NAME=$(mysqlDatabase) \
                          DB_USER=$(mysqlAdminUser) \
                          DB_PASSWORD="$(MYSQL_ADMIN_PASSWORD)" \
                        --restart-policy Always \
                        --location $(location)

                      echo "‚úÖ Deploy conclu√≠do!"
                      echo "üåê URL: http://sprint4-rm558253.$(location).azurecontainer.io:8080"

                - task: AzureCLI@2
                  displayName: 'Verificar Status do Deploy'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "üîç Verificando status do container..."
                      az container show \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) \
                        --query "{Status:instanceView.state, FQDN:ipAddress.fqdn, IP:ipAddress.ip}" \
                        -o table

                      echo ""
                      echo "üìã Logs do container (√∫ltimas 50 linhas):"
                      az container logs \
                        --resource-group $(resourceGroup) \
                        --name $(aciName) | tail -n 50
